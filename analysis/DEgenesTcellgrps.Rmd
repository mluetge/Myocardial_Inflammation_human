---
title: "DE genes between T cell groups"
author: "Mechthild LÃ¼tge"
date: "Dec 2022"
output:
  html_document:
    self_contained: no
    code_folding: show
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: true
    collapsed: no
    smooth_scroll: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
set.seed(1000)
```

## load packages
```{r libs}
suppressPackageStartupMessages({
  library(SingleCellExperiment)
  library(tidyverse)
  library(Seurat)
  library(magrittr)
  library(dplyr)
  library(purrr)
  library(ggplot2)
  library(here)
  library(runSeurat3)
  library(ggsci)
  library(pheatmap)
  library(ggpubr)
  library(clusterProfiler)
  library(org.Hs.eg.db)
  library(DOSE)
  library(enrichplot)
  library(viridis)
})

```


## heatmap function

```{r avg heatmap funct}
avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(^.*?_)","",
                                       colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=gsub("(_.*$)","",colnames(logNormExpresMa)))
  colnames(annotation_col)[1] <- "col1"
  annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub(".*_","",col1)) %>%
    dplyr::select(cond, celltype)
  rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colVecCond,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

```



## set dir
```{r set dir}
basedir <- here()
seurat <- readRDS(file = paste0(basedir, 
                              "/data/humanHeartsPlusGraz_intPatients_merged", 
                              "labeled_woHH_seurat.rds"))
Idents(seurat) <- seurat$integrated_snn_res.0.6

```



## color vectors
```{r colVec}

colPal <- c(pal_igv()(12),
            pal_aaas()(10))[1:length(levels(seurat))]
colTec <- pal_jama()(length(unique(seurat$technique)))
colSmp <- c(pal_uchicago()(9), pal_npg()(10), pal_aaas()(10), 
            pal_jama()(7))[1:length(unique(seurat$dataset))]
colCond <- pal_npg()(length(unique(seurat$cond)))
colID <- c(pal_jco()(10), pal_npg()(10), pal_futurama()(10),
           pal_d3()(10))[1:length(unique(seurat$ID))]
colOrig <- pal_aaas()(length(unique(seurat$origin)))
colIso <- pal_nejm()(length(unique(seurat$isolation)))
colProc <- pal_aaas()(length(unique(seurat$processing)))
colTgrp <- c("#9f2238", "#48557e", "#71737a")
colLab <- c("#1b805d", "#C71000FF", "#344080", "#803467", "#5A9599FF",
            "#FF6348FF", "#84D7E1FF", "#8A9045FF", "#800000FF", "#767676FF",
            "#FFA319FF", "#FF95A8FF") 

names(colLab) <- c("EndoEC", "Tcell","resMacrophage", "Fibroblast",
                   "infMacrophage", "Perivascular","Cardiomyocyte",
                   "Endothelial","Adipocytes","NeuralCells","SMC","LEC")
names(colTgrp) <- c("TcellHigh", "TcellLow", "TcellInt" )
names(colPal) <- levels(seurat)
names(colTec) <- unique(seurat$technique)
names(colSmp) <- unique(seurat$dataset)
names(colCond) <- unique(seurat$cond)
names(colID) <- unique(seurat$ID)
names(colOrig) <- unique(seurat$origin)
names(colIso) <- unique(seurat$isolation)
names(colProc) <- unique(seurat$processing)
```


## vis data {.tabset}
### clusters
```{r vis cluster}
DimPlot(seurat, reduction = "umap", cols=colPal)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

DimPlot(seurat, reduction = "umap", cols=colPal,
        shuffle = T)+
  theme_void()

```

### label
```{r vis label}
DimPlot(seurat, reduction = "umap",  group.by = "label", cols=colLab)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

DimPlot(seurat, reduction = "umap", group.by = "label", cols=colLab,
        shuffle = T)+
  theme_void()
```


### ID
```{r vis ID}

DimPlot(seurat, reduction = "umap", group.by = "ID", cols=colID, shuffle = T)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

DimPlot(seurat, reduction = "umap", group.by = "ID", cols=colID,
        shuffle = T)+
  theme_void()

```


### cond
```{r vis cond, fig.height=4, fig.width=5}

DimPlot(seurat, reduction = "umap", group.by = "cond", cols=colCond)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### T cell grp
```{r vis T cell group}

DimPlot(seurat, reduction = "umap", group.by = "TcellGrp", cols=colTgrp)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

DimPlot(seurat, reduction = "umap", group.by = "TcellGrp", cols=colTgrp,
        shuffle = T)+
  theme_void()

```


### label split by T cell Grp
```{r vis label split seq, fig.height=3.5, fig.width=12}

DimPlot(seurat, reduction = "umap", group.by = "label", cols=colLab,
        split.by = "TcellGrp", shuffle = T)+
  theme_void()

```

## overall DE genes {.tabset}
```{r downsample seurat}
## downsample to equal number of cells per celltype (min 300 cells as 
## T cell low grp has around 300 T cells)
Idents(seurat) <- seurat$TcellGrp
seurat$label_plus_TcellGrp <- paste0(seurat$label, "_", seurat$TcellGrp)
Idents(seurat) <- seurat$label_plus_TcellGrp
seuratSub <- subset(seurat, downsample = 300)
table(seuratSub$label, seuratSub$TcellGrp)
```

### overall DE genes all grps
```{r overall DE all grps, fig.height=10, fig.width=10}

seuratSub$label <- factor(seuratSub$label)
Idents(seuratSub) <- seuratSub$TcellGrp
overallDE <- FindAllMarkers(object = seuratSub, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.05,
                                     logfc.threshold = 0.1,
                                     test.use = "wilcox")
overallDE <- overallDE %>% filter(p_val_adj < 0.05)

grpVec <- unique(seuratSub$TcellGrp)
GOcons <- lapply(grpVec, function(cl){
  DEgenesSub <- overallDE %>% 
    filter(cluster == cl) %>% mutate(ENS=gsub("\\..*$", "", gene)) %>% 
    slice_min(., p_val_adj, n=250)
  egoSS <- enrichGO(gene      = unique(DEgenesSub$ENS),
                OrgDb         = org.Hs.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
  egoSS <- setReadable(egoSS, OrgDb = org.Hs.eg.db)
  egoSSres <- egoSS@result %>% filter(p.adjust < 0.05) %>% 
    mutate(subset=cl)
})

names(GOcons) <- grpVec

## write list with DE genes and GO terms
write.table(overallDE, quote=F, row.names = F,col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "downsampOverallDE_allGrps.txt"))
GOconsDat <- do.call("rbind", GOcons)
write.table(GOconsDat, quote=F, row.names = T, col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "downsampOverallDE_allGrps",
                              "_GO.txt"))


```




### T cell high vs T cell low
```{r overall DE Tcell high vs low, fig.height=10, fig.width=10}

seuratSub2 <- subset(seuratSub, TcellGrp %in% c("TcellHigh", "TcellLow"))
seuratSub2$label <- factor(seuratSub2$label)
Idents(seuratSub2) <- seuratSub2$TcellGrp
overallDE_ThighLow <- FindAllMarkers(object = seuratSub2, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.05,
                                     logfc.threshold = 0.1,
                                     test.use = "wilcox")
overallDE_ThighLow <- overallDE_ThighLow %>% filter(p_val_adj < 0.05)

grpVec <- unique(seuratSub2$TcellGrp)
GOcons <- lapply(grpVec, function(cl){
  DEgenesSub <- overallDE_ThighLow %>% 
    filter(cluster == cl) %>% mutate(ENS=gsub("\\..*$", "", gene)) %>% 
    slice_min(., p_val_adj, n=250)
  egoSS <- enrichGO(gene      = unique(DEgenesSub$ENS),
                OrgDb         = org.Hs.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
  egoSS <- setReadable(egoSS, OrgDb = org.Hs.eg.db)
  egoSSres <- egoSS@result %>% filter(p.adjust < 0.05) %>% 
    mutate(subset=cl)
})

names(GOcons) <- grpVec

## write list with DE genes and GO terms
write.table(overallDE_ThighLow, quote=F, row.names = F,col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "downsampOverallDE_TcellHigh_vs_TcellLow.txt"))
GOconsDat <- do.call("rbind", GOcons)
write.table(GOconsDat, quote=F, row.names = T, col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "downsampOverallDE_TcellHigh_vs_TcellLow",
                              "_GO.txt"))


```


### T cell high vs T cell int
```{r overall DE Tcell high vs int, fig.height=10, fig.width=10}

seuratSub2 <- subset(seuratSub, TcellGrp %in% c("TcellHigh", "TcellInt"))
seuratSub2$label <- factor(seuratSub2$label)
Idents(seuratSub2) <- seuratSub2$TcellGrp
overallDE_ThighInt <- FindAllMarkers(object = seuratSub2, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.05,
                                     logfc.threshold = 0.1,
                                     test.use = "wilcox")
overallDE_ThighInt <- overallDE_ThighInt %>% filter(p_val_adj < 0.05)

grpVec <- unique(seuratSub2$TcellGrp)
GOcons <- lapply(grpVec, function(cl){
  DEgenesSub <- overallDE_ThighInt %>% 
    filter(cluster == cl) %>% mutate(ENS=gsub("\\..*$", "", gene)) %>% 
    slice_min(., p_val_adj, n=250)
  egoSS <- enrichGO(gene      = unique(DEgenesSub$ENS),
                OrgDb         = org.Hs.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
  egoSS <- setReadable(egoSS, OrgDb = org.Hs.eg.db)
  egoSSres <- egoSS@result %>% filter(p.adjust < 0.05) %>% 
    mutate(subset=cl)
})

names(GOcons) <- grpVec

## write list with DE genes and GO terms
write.table(overallDE_ThighInt, quote=F, row.names = F,col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "downsampOverallDE_TcellHigh_vs_TcellInt.txt"))
GOconsDat <- do.call("rbind", GOcons)
write.table(GOconsDat, quote=F, row.names = T, col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "downsampOverallDE_TcellHigh_vs_TcellInt",
                              "_GO.txt"))


```


### T cell int vs T cell low
```{r overall DE Tcell int vs low, fig.height=10, fig.width=10}

seuratSub2 <- subset(seuratSub, TcellGrp %in% c("TcellLow", "TcellInt"))
seuratSub2$label <- factor(seuratSub2$label)
Idents(seuratSub2) <- seuratSub2$TcellGrp
overallDE_TLowInt <- FindAllMarkers(object = seuratSub2, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.05,
                                     logfc.threshold = 0.1,
                                     test.use = "wilcox")
overallDE_TLowInt <- overallDE_TLowInt %>% filter(p_val_adj < 0.05)

grpVec <- unique(seuratSub2$TcellGrp)
GOcons <- lapply(grpVec, function(cl){
  DEgenesSub <- overallDE_TLowInt %>% 
    filter(cluster == cl) %>% mutate(ENS=gsub("\\..*$", "", gene)) %>% 
    slice_min(., p_val_adj, n=250)
  egoSS <- enrichGO(gene      = unique(DEgenesSub$ENS),
                OrgDb         = org.Hs.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
  egoSS <- setReadable(egoSS, OrgDb = org.Hs.eg.db)
  egoSSres <- egoSS@result %>% filter(p.adjust < 0.05) %>% 
    mutate(subset=cl)
})

names(GOcons) <- grpVec

## write list with DE genes and GO terms
write.table(overallDE_TLowInt, quote=F, row.names = F,col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "downsampOverallDE_TcellLow_vs_TcellInt.txt"))
GOconsDat <- do.call("rbind", GOcons)
write.table(GOconsDat, quote=F, row.names = T, col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "downsampOverallDE_TcellLow_vs_TcellInt",
                              "_GO.txt"))


```

### T cell high vs T cell low plus int
```{r overall DE Tcell int vs low plus int, fig.height=10, fig.width=10}

seuratSub2 <- seuratSub
seuratSub2$TcellGrp2 <- seuratSub2$TcellGrp
seuratSub2$TcellGrp2[which(seuratSub2$TcellGrp %in% c("TcellLow", "TcellInt"))] <- "TcellLowInt"
Idents(seuratSub2) <- seuratSub2$TcellGrp2
overallDE_T2 <- FindAllMarkers(object = seuratSub2, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.05,
                                     logfc.threshold = 0.1,
                                     test.use = "wilcox")
overallDE_T2 <- overallDE_T2 %>% filter(p_val_adj < 0.05)

grpVec <- unique(seuratSub2$TcellGrp2)
GOcons <- lapply(grpVec, function(cl){
  DEgenesSub <- overallDE_T2 %>% 
    filter(cluster == cl) %>% mutate(ENS=gsub("\\..*$", "", gene)) %>% 
    slice_min(., p_val_adj, n=250)
  egoSS <- enrichGO(gene      = unique(DEgenesSub$ENS),
                OrgDb         = org.Hs.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
  egoSS <- setReadable(egoSS, OrgDb = org.Hs.eg.db)
  egoSSres <- egoSS@result %>% filter(p.adjust < 0.05) %>% 
    mutate(subset=cl)
})

names(GOcons) <- grpVec

## write list with DE genes and GO terms
write.table(overallDE_T2, quote=F, row.names = F,col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "downsampOverallDE_TcellHigh_vs_TcellLowPlusInt.txt"))
GOconsDat <- do.call("rbind", GOcons)
write.table(GOconsDat, quote=F, row.names = T, col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "downsampOverallDE_TcellHigh_vs_TcellLowPlusInt",
                              "_GO.txt"))


```



## cw DE genes all grps

```{r cw DE genes}
## no downsampling..
Idents(seurat) <- seurat$TcellGrp
grpVec <- unique(seurat$label)

clustDE <- lapply(grpVec, function(grp){
  grpSub <- unique(seurat$label)[which(
    unique(seurat$label)==grp)]
  seuratSub2 <- subset(seurat, label == grpSub)
  DEgenes <-FindAllMarkers(seuratSub2, only.pos=T, logfc.threshold = 0.25,
                           min.pct = 0.1)
  if(nrow(DEgenes)>1){
    DEgenes <- DEgenes %>% filter(p_val_adj<0.01) %>%
      mutate(group=paste0(grp, "_", cluster)) %>% 
      mutate(geneID=gene) %>% mutate(gene=gsub(".*\\.", "",  geneID)) %>% 
      filter(nchar(gene)>1)
    }
})

names(clustDE) <- grpVec

clustDE_Dat <- data.frame(do.call("rbind", clustDE))
write.table(clustDE_Dat, quote=F, row.names = F,col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "CWDE_allGrps.txt"))

```



### avg Heatmap top cwDE genes {.tabset}
```{r avgHeat cwDE, warning=FALSE, echo = FALSE}

## only cluster with > 1 DE genes
deCnt <- lapply(clustDE, nrow)
deCnt <- data.frame(cnt=do.call("rbind", deCnt)) %>%
  rownames_to_column(var = "cluster") %>% filter(cnt>1)

grpVec <- as.character(deCnt$cluster)
seurat$label_plus_TcellGrp <- as.factor(seurat$label_plus_TcellGrp)
Idents(seurat) <- seurat$label_plus_TcellGrp

template_ah <- c(
    "#### {{grp}}\n",
    "```{r avgHeat cwDE {{grp}},echo = FALSE,fig.height=10,fig.width=10}\n",
    "DeSub <- clustDE[[as.character('{{grp}}')]]",
    "DeSel <- DeSub %>% top_n(., 30, avg_log2FC)",
    "gapVecCol <- seq(3, length(levels(seurat$label_plus_TcellGrp)), by=3)",
    "pOut <- avgHeatmap(seurat = seurat, selGenes = DeSel,
                     colVecIdent = colLab, colVecCond=colTgrp,
                     ordVec=levels(seurat),
                     gapVecR=NULL, gapVecC=gapVecCol,cc=FALSE,
                     cr=T, condCol=T)\n",
    "```\n",
    "\n"
)

plots_ah <- lapply(grpVec, 
  function(grp) knitr::knit_expand(text = template_ah)
)

```

`r knitr::knit(text = unlist(plots_ah))`

## cw DE genes T cell high vs T cell low

```{r cw DE genes T cell high vs T cell low}
## no downsampling..
seuratSub3 <- subset(seurat, TcellGrp %in% c("TcellLow", "TcellHigh"))

Idents(seuratSub3) <- seuratSub3$TcellGrp
grpVec <- unique(seuratSub3$label)

clustDE <- lapply(grpVec, function(grp){
  grpSub <- unique(seuratSub3$label)[which(
    unique(seuratSub3$label)==grp)]
  seuratSub2 <- subset(seuratSub3, label == grpSub)
  DEgenes <-FindAllMarkers(seuratSub2, only.pos=T, logfc.threshold = 0.25,
                           min.pct = 0.1)
  if(nrow(DEgenes)>1){
    DEgenes <- DEgenes %>% filter(p_val_adj<0.01) %>%
      mutate(group=paste0(grp, "_", cluster)) %>% 
      mutate(geneID=gene) %>% mutate(gene=gsub(".*\\.", "",  geneID)) %>% 
      filter(nchar(gene)>1)
    }
})

names(clustDE) <- grpVec

clustDE_Dat <- data.frame(do.call("rbind", clustDE))
write.table(clustDE_Dat, quote=F, row.names = F,col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "CWDE_TcellHigh_vs_TcellLow.txt"))

```



## Fibroblast DE genes {.tabset}
```{r subset Fibroblast only}

table(seurat$label, seurat$TcellGrp)
## all grps > 3000 cells --> no need to downsample

Idents(seurat) <- seurat$label_plus_TcellGrp
seuratSub <- subset(seurat, label=="Fibroblast")

```

### Fibroblast DE genes all grps
```{r oFibroblast DE all grps, fig.height=10, fig.width=10}

Idents(seuratSub) <- seuratSub$TcellGrp
overallDE <- FindAllMarkers(object = seuratSub, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.05,
                                     logfc.threshold = 0.1,
                                     test.use = "wilcox")
overallDE <- overallDE %>% filter(p_val_adj < 0.05)

grpVec <- unique(seuratSub$TcellGrp)
GOcons <- lapply(grpVec, function(cl){
  DEgenesSub <- overallDE %>% 
    filter(cluster == cl) %>% mutate(ENS=gsub("\\..*$", "", gene)) %>% 
    slice_min(., p_val_adj, n=250)
  egoSS <- enrichGO(gene      = unique(DEgenesSub$ENS),
                OrgDb         = org.Hs.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
  egoSS <- setReadable(egoSS, OrgDb = org.Hs.eg.db)
  egoSSres <- egoSS@result %>% filter(p.adjust < 0.05) %>% 
    mutate(subset=cl)
})

names(GOcons) <- grpVec

## write list with DE genes and GO terms
write.table(overallDE, quote=F, row.names = F,col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "FibroblastDE_allGrps.txt"))
GOconsDat <- do.call("rbind", GOcons)
write.table(GOconsDat, quote=F, row.names = T, col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "FibroblastDE_allGrps",
                              "_GO.txt"))


```




### T cell high vs T cell low
```{r Fibroblast DE Tcell high vs low, fig.height=10, fig.width=10}

seuratSub2 <- subset(seuratSub, TcellGrp %in% c("TcellHigh", "TcellLow"))
seuratSub2$label <- factor(seuratSub2$label)
Idents(seuratSub2) <- seuratSub2$TcellGrp
overallDE_ThighLow <- FindAllMarkers(object = seuratSub2, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.05,
                                     logfc.threshold = 0.1,
                                     test.use = "wilcox")
overallDE_ThighLow <- overallDE_ThighLow %>% filter(p_val_adj < 0.05)

grpVec <- unique(seuratSub2$TcellGrp)
GOcons <- lapply(grpVec, function(cl){
  DEgenesSub <- overallDE_ThighLow %>% 
    filter(cluster == cl) %>% mutate(ENS=gsub("\\..*$", "", gene)) %>% 
    slice_min(., p_val_adj, n=250)
  egoSS <- enrichGO(gene      = unique(DEgenesSub$ENS),
                OrgDb         = org.Hs.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
  egoSS <- setReadable(egoSS, OrgDb = org.Hs.eg.db)
  egoSSres <- egoSS@result %>% filter(p.adjust < 0.05) %>% 
    mutate(subset=cl)
})

names(GOcons) <- grpVec

## write list with DE genes and GO terms
write.table(overallDE_ThighLow, quote=F, row.names = F,col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "FibroblastDE_TcellHigh_vs_TcellLow.txt"))
GOconsDat <- do.call("rbind", GOcons)
write.table(GOconsDat, quote=F, row.names = T, col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "FibroblastDE_TcellHigh_vs_TcellLow",
                              "_GO.txt"))


```

#### vis enrichment analysis GO terms barplots
```{r barplot, fig.height=8, fig.width=10}

selGO <- read_tsv(paste0(basedir,"/data/GSEA/selGO.txt")) %>% 
  mutate(ID_plus_grp=paste0(GOterm, "_", Grp))
GOconsDat <- GOconsDat %>% mutate(ID_plus_grp=paste0(ID, "_", subset)) %>% 
  filter(ID_plus_grp %in% selGO$ID_plus_grp) 

grpVec <- unique(selGO$Grp)
lapply(grpVec, function(grp){
  selGODat <- GOconsDat %>% filter(subset == grp)
  selGODat <- selGODat %>% mutate(qscore=-log(p.adjust, base=10)) 
  p <- ggbarplot(selGODat, x = "Description", y = "qscore",
          fill = "subset",               
          color = "subset",            
          palette = colTgrp,            
          sort.val = "asc",           
          sort.by.groups = TRUE      
          #x.text.angle = 90           
          ) + 
  rotate()
p
})

```

#### vis enrichment analysis GO terms network
```{r network, fig.height=8, fig.width=10}

grpVec <- unique(selGO$Grp)
colTgrpGen <- c("#c96778", "#8391ba")
names(colTgrpGen) <- grpVec

lapply(grpVec, function(cl){
  DEgenesSub <- overallDE_ThighLow %>% 
    filter(cluster == cl) %>% mutate(ENS=gsub("\\..*$", "", gene)) %>% 
    slice_min(., p_val_adj, n=250)
  egoSS <- enrichGO(gene      = unique(DEgenesSub$ENS),
                OrgDb         = org.Hs.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
  egoSS <- setReadable(egoSS, OrgDb = org.Hs.eg.db)
  egoSSres <- egoSS@result %>% filter(p.adjust < 0.05) %>% 
    filter(ID %in% selGO$GOterm)
  egoSS@result <- egoSSres
  colNode <- colTgrp[cl]
  colGene <- colTgrpGen[cl]
  p <- cnetplot(egoSS, showCategory=10, node_label="all", 
        color_category=colNode, 
        color_gene=colGene,
        shadowtext="none") 
  p
})

```

#### vis enrichment analysis GO terms combined network
```{r combined network, fig.height=8, fig.width=10}

grpVec <- unique(selGO$Grp)

orgMarkerList <- lapply(grpVec, function(grp){
  selMarker <- overallDE_ThighLow %>% filter(cluster == grp) %>%
    mutate(EnsID=gsub("\\..*$", "", gene)) %>% 
    slice_min(., p_val_adj, n=250)
  out <- selMarker$EnsID
})
names(orgMarkerList) <- grpVec

ck <- compareCluster(geneCluster = orgMarkerList,
                     fun = enrichGO,
                     OrgDb = org.Hs.eg.db,
                     keyType = 'ENSEMBL',
                     ont = "BP",
                     pvalueCutoff  = 0.1,
                     qvalueCutoff  = 0.1
)
ck <- setReadable(ck, OrgDb = org.Hs.eg.db)

cnetplot(ck, showCategory = 10, shadowtext="none") +
  scale_fill_manual(values = colTgrp)


```


#### vis enrichment analysis GO terms heatmap
```{r heatmap GO terms, fig.height=6, fig.width=35}

logFCdat <- overallDE_ThighLow %>%
  mutate(log2FC=ifelse(cluster=="TcellLow", -1*avg_log2FC, avg_log2FC)) %>% 
  mutate(geneID=gsub(".*\\.", "", gene)) %>% 
  dplyr::select(log2FC, geneID)

IDtoDesc <- GOconsDat %>% dplyr::select(ID, Description)
geneIDList <- lapply(GOconsDat$ID, function(id){
  selGenes <- data.frame(strsplit(GOconsDat$geneID[which(GOconsDat$ID == id)],
                               split = "/")) 
  colnames(selGenes) <- "geneID"
  selGenes <- selGenes %>% mutate(ID=id)
})
geneIDdat <- do.call("rbind", geneIDList) %>%
  left_join(., IDtoDesc, by="ID") %>% 
  left_join(., logFCdat, by="geneID") %>% 
  dplyr::select(-ID) %>% 
  spread(., Description, log2FC)

geneIDmat <- t(as.matrix(geneIDdat[,-1]))
colnames(geneIDmat) <- geneIDdat$geneID
ordDat <- do.call("rbind", geneIDList) %>%
  left_join(., IDtoDesc, by="ID")
geneIDmat <- geneIDmat[unique(ordDat$Description),ordDat$geneID]

pheatmap(geneIDmat, scale="none" ,treeheight_row = 0, cluster_rows = F, 
         cluster_cols = F, na_col = "#FFFFFF",
         color = colorRampPalette(c("#005083", "#0064ab","#6876a4","#9f8a89",
                                    "#c99f6e", "#f0b64d","#ffd28f"))(50),
         cellwidth=15, cellheight=10,
         main = "log2FC T cell high vs T cell low")

```


### T cell high vs T cell int
```{r Fibroblast DE Tcell high vs int, fig.height=10, fig.width=10}

seuratSub2 <- subset(seuratSub, TcellGrp %in% c("TcellHigh", "TcellInt"))
seuratSub2$label <- factor(seuratSub2$label)
Idents(seuratSub2) <- seuratSub2$TcellGrp
overallDE_ThighInt <- FindAllMarkers(object = seuratSub2, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.05,
                                     logfc.threshold = 0.1,
                                     test.use = "wilcox")
overallDE_ThighInt <- overallDE_ThighInt %>% filter(p_val_adj < 0.05)

grpVec <- unique(seuratSub2$TcellGrp)
GOcons <- lapply(grpVec, function(cl){
  DEgenesSub <- overallDE_ThighInt %>% 
    filter(cluster == cl) %>% mutate(ENS=gsub("\\..*$", "", gene)) %>% 
    slice_min(., p_val_adj, n=250)
  egoSS <- enrichGO(gene      = unique(DEgenesSub$ENS),
                OrgDb         = org.Hs.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
  egoSS <- setReadable(egoSS, OrgDb = org.Hs.eg.db)
  egoSSres <- egoSS@result %>% filter(p.adjust < 0.05) %>% 
    mutate(subset=cl)
})

names(GOcons) <- grpVec

## write list with DE genes and GO terms
write.table(overallDE_ThighInt, quote=F, row.names = F,col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "FibroblastDE_TcellHigh_vs_TcellInt.txt"))
GOconsDat <- do.call("rbind", GOcons)
write.table(GOconsDat, quote=F, row.names = T, col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "FibroblastDE_TcellHigh_vs_TcellInt",
                              "_GO.txt"))


```


### T cell int vs T cell low
```{r Fibroblast DE Tcell int vs low, fig.height=10, fig.width=10}

seuratSub2 <- subset(seuratSub, TcellGrp %in% c("TcellLow", "TcellInt"))
seuratSub2$label <- factor(seuratSub2$label)
Idents(seuratSub2) <- seuratSub2$TcellGrp
overallDE_TLowInt <- FindAllMarkers(object = seuratSub2, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.05,
                                     logfc.threshold = 0.1,
                                     test.use = "wilcox")
overallDE_TLowInt <- overallDE_TLowInt %>% filter(p_val_adj < 0.05)

grpVec <- unique(seuratSub2$TcellGrp)
GOcons <- lapply(grpVec, function(cl){
  DEgenesSub <- overallDE_TLowInt %>% 
    filter(cluster == cl) %>% mutate(ENS=gsub("\\..*$", "", gene)) %>% 
    slice_min(., p_val_adj, n=250)
  egoSS <- enrichGO(gene      = unique(DEgenesSub$ENS),
                OrgDb         = org.Hs.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
  egoSS <- setReadable(egoSS, OrgDb = org.Hs.eg.db)
  egoSSres <- egoSS@result %>% filter(p.adjust < 0.05) %>% 
    mutate(subset=cl)
})

names(GOcons) <- grpVec

## write list with DE genes and GO terms
write.table(overallDE_TLowInt, quote=F, row.names = F,col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "FibroblastDE_TcellLow_vs_TcellInt.txt"))
GOconsDat <- do.call("rbind", GOcons)
write.table(GOconsDat, quote=F, row.names = T, col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "FibroblastDE_TcellLow_vs_TcellInt",
                              "_GO.txt"))


```

### T cell high vs T cell low plus int
```{r Fibroblast DE Tcell int vs low plus int, fig.height=10, fig.width=10}

seuratSub2 <- seuratSub
seuratSub2$TcellGrp2 <- seuratSub2$TcellGrp
seuratSub2$TcellGrp2[which(seuratSub2$TcellGrp %in% c("TcellLow", "TcellInt"))] <- "TcellLowInt"
Idents(seuratSub2) <- seuratSub2$TcellGrp2
overallDE_T2 <- FindAllMarkers(object = seuratSub2, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.05,
                                     logfc.threshold = 0.1,
                                     test.use = "wilcox")
overallDE_T2 <- overallDE_T2 %>% filter(p_val_adj < 0.05)

grpVec <- unique(seuratSub2$TcellGrp2)
GOcons <- lapply(grpVec, function(cl){
  DEgenesSub <- overallDE_T2 %>% 
    filter(cluster == cl) %>% mutate(ENS=gsub("\\..*$", "", gene)) %>% 
    slice_min(., p_val_adj, n=250)
  egoSS <- enrichGO(gene      = unique(DEgenesSub$ENS),
                OrgDb         = org.Hs.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
  egoSS <- setReadable(egoSS, OrgDb = org.Hs.eg.db)
  egoSSres <- egoSS@result %>% filter(p.adjust < 0.05) %>% 
    mutate(subset=cl)
})

names(GOcons) <- grpVec

## write list with DE genes and GO terms
write.table(overallDE_T2, quote=F, row.names = F,col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "FibroblastDE_TcellHigh_vs_TcellLowPlusInt.txt"))
GOconsDat <- do.call("rbind", GOcons)
write.table(GOconsDat, quote=F, row.names = T, col.names = T, sep= "\t",
            file = paste0(basedir,"/data/GSEA/humanHeartsPlusGraz_intPatients_", 
                              "FibroblastDE_TcellHigh_vs_TcellLowPlusInt",
                              "_GO.txt"))


```



## session info
```{r session info}
sessionInfo()
date()
```




